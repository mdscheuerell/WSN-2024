---
title: "Effects of species interactions and environmental drivers on community stability"
subtitle: "Mark Scheuerell"
author: "U.S. Geological Survey<br>Washington Cooperative Fish and Wildlife Research Unit<br><br>School of Aquatic and Fishery Sciences<br>University of Washington"
output:
  xaringan::moon_reader:
    css: ["xaringan-themer.css", "my-theme.css"]
    nature:
      slideNumberFormat: ""
      highlightStyle: github
      highlightLines: true
      ratio: 16:9
      # countIncrementalSlides: false
---

```{r setup, include=FALSE}
options(htmltools.dir.version = FALSE)
knitr::opts_chunk$set(
  fig.width = 8, fig.height=4, fig.retina=3, fig.align = "center",
  out.width = "100%",
  cache = FALSE,
  echo = FALSE,
  message = FALSE, 
  warning = FALSE,
  hiline = TRUE
)

## set random seed
set.seed(666)

## load {icons} for font awesome
library(icons)
```

```{r xaringan-themer, include=FALSE, warning = FALSE}
library(xaringanthemer)
style_duo(
  primary_color = "#FFFFFF",
  secondary_color = "#23395b",
  # secondary_color = "#FF961C",
  title_slide_text_color = "#FFFFFF",
  title_slide_background_color = "#23395b",
  colors = c(
    red = "#c10101",
    purple = "#844870",
    purple2 = "#5c00b6",
    orange = "#ff8100",
    green = "#339933",
    white = "#FFFFFF",
    blue = "#488fdf",
    blue2 = "#030c84",
    aqua = "#80cdc1",
    gray = "#808080",
    lightgray = "#bdbdbd"
),
  header_font_google = google_font("Roboto Condensed"),
  text_font_google = google_font("Cabin", "400", "400i", "700"),
)
```

# Acknowledgments

> ## .blue[ Elizabeth "Eli" Holmes (NOAA) ]

> ## .blue[ Eric Ward (NOAA) ]

> ## .blue[ Various others ]

---

class: center, middle, inverse

# Estimating species interactions<br>has a long history in ecology


---

class: middle

# .green[ &nbsp; &nbsp; &nbsp; Predation ]

# .orange.center[ Competition ]

# .blue.right[ Facilitation &nbsp; &nbsp; &nbsp; ]

---

class: inverse-black

background-image: url(figs/bob_paine.jpg)
background-size: 55%

#### .citation.center.gray[Anne Paine ]


---

class: inverse-black

background-image: url(figs/steve_carpenter.jpg)
background-size: 70%

#### .citation.center.gray[Adam<br>Hinterthuer]


---

background-image: url(figs/ives2003.png)
background-size: 95%


---

class: center

# We can use time series of abundance...

```{r plot_many_ts, echo=FALSE, dpi=300, fig.height=4, fig.width = 8, fig.align='center'}
NN <- 3
TT <- 30
MM <- 3
 
set.seed(123)
## MM x TT matrix of innovations
ww <- matrix(rnorm(MM*TT, 0, 1), MM, TT)
ww[,1] <- rnorm(MM, 0, sqrt(5))
## MM x TT matrix of scaled latent trends
xx <- t(scale(apply(ww, 1, cumsum)))

## loadings matrix
ZZ <- matrix(runif(NN*MM, -1, 1), NN, MM)
diag(ZZ) <- rev(sort(abs(diag(ZZ))))
ZZ[upper.tri(ZZ)] <- 0
ZZ <- round(ZZ, 2)

## obs var
obs_var <- 0.2^2
## obs errors
ee <- t(MASS::mvrnorm(TT, matrix(0, NN, 1), diag(obs_var, NN, NN)))
## NN x TT matrix of observed data
yy <- ZZ %*% xx + ee

clr <- c("#339933", "#80cdc1", "#488fdf")

vv <- sample(seq(NN), NN)

labs <- c("Producer", "Herbivore", "Predator")

par(mfrow = c(1,3), mai = c(1, 0.5, 0.5, 0.5), omi=c(0, 0, 0, 0)) 

for(i in 1:NN) {
  plot.ts(yy[vv[i],], lwd = 4,
          xlab = "", xaxt = "n", ylab = "", yaxt = "n",
          main = labs[i], cex.main = 2.5, col.main = clr[i],
          col = clr[i], bty = "n")
}
```


---

class: center

#  to get intra- & interspecific interaction strengths

```{r food_web, dpi=300, fig.height=4, fig.width = 8, out.height = "90%", out.width = "90%", fig.align='center', echo=FALSE, warning = FALSE}
## boundaries
ss <- 5
nn <- 8
rr <- ss*3
cc <- ss*nn
## mid-points
xm <- seq(5,cc-ss,rr)
ymt <- rr - ss/2
ymb <- ss/2
## arrow locs
y0 <- rr - ss
y1 <- ss

par(mai = c(0.5, 0, 0.1, 0), omi = rep(0, 4))

## empty plot space
plot(c(0,cc), c(0,rr), type = "n", xlab = "", ylab = "",
     xaxt = "n", yaxt = "n", bty = "n")

## top box
symbols(x = xm[2], y = ymt, rectangles = matrix(c(2*ss,ss),1,2),
        lty = "solid",  bg = "#80cdc1", fg = NA,
        inches = FALSE, add = TRUE, lwd = 3)
text("Consumer", x = xm[2], y = ymt, cex = 2, col = "#ffffff")
text("-0.5", x = xm[2] * 0.95, y = y0 - (y0 - y1) / 2, pos = 2,
     cex = 2, col = "#80cdc1")
text("0.6", x = xm[2] * 1.33, y = ymt,
     cex = 2, col = "#80cdc1")
## arrows
arrows(x0 = xm[2] * 0.95, y0 = y0, y1 = y1,
       col = "#80cdc1", lwd = 3, length = 0.12)
## circle
symbols(x = xm[2] * 1.33, y = ymt, circles = c(2),
        lty = "solid",  fg = "#80cdc1", bg = NA,
        inches = FALSE, add = TRUE, lwd = 3)

## bottom box
symbols(x = xm[2], y = ymb, rectangles = matrix(c(2*ss,ss),1,2),
        lty = "solid",  bg = "#488fdf", fg = NA,
        inches = FALSE, add = TRUE, lwd = 3)
text("Producer", x = xm[2], y = ymb, cex = 2, col = "#ffffff")
text("0.7", x = xm[2] * 1.05, y = y0 - (y0 - y1) / 2, pos = 4,
     cex = 2, col = "#488fdf")
text("0.8", x = xm[2] * 1.33, y = ymb,
     cex = 2, col = "#488fdf")
## arrows
arrows(x0 = xm[2] * 1.05, y0 = y1, y1 = y0,
       col = "#488fdf", lwd = 3, length = 0.12)
## circle
symbols(x = xm[2] * 1.33, y = ymb, circles = c(2),
        lty = "solid",  fg = "#488fdf", bg = NA,
        inches = FALSE, add = TRUE, lwd = 3)
```


---

class: inverse, center, middle

# So how does one do this?


---

class: inverse, center, middle

# Let's begin with a model for population size


---

# Assumptions &#129300;

> ## .blue[ The size of a population can change over time ]

> ## .blue[ Those changes are density dependent ]


---

<br>

## .blue.center[ &#129299; Discrete-time Gompertz model ]

$$\LARGE N_t = N_{t-1} \exp{(r_{\max} + (b - 1) \log(N_{t-1}))}$$

<br>

## .blue.center[ &#128587; in other words ]

## .center[A population grows smoothly toward its carry capacity ]


---

class: center

# Example of Gompertz population growth

```{r ex_gompertz, fig.align = "center", fig.dim=c(6,3)}
## number of time steps
TT <- 20

r_max <- 2
b <- 0.6

NN <- rep(NA, TT)
NN[1] <- 1

for(tt in 2:TT) {
  NN[tt] <- NN[tt-1] * exp(r_max + (b - 1) * log(NN[tt-1]))
}

par(mai = c(1, 0.5, 0, 0), omi = c(0, 0, 0, 0))
plot.ts(NN, lwd = 2, type = "o", pch = 16, col = "dodgerblue",
        yaxt = "n",
        ylab = "")
# text(x = 5, y = 120, expression(italic(r[max]) == 1))
# text(x = 5, y = 100, expression(italic(b) == 0.8))
mtext(expression(italic(N[t])),
      side = 2, line = 1, cex = 1.5, las = 1)
```


---

class: inverse-black

background-image: url(figs/harsh_environment.jpg)
background-size: 99%

#### .citation.center.gray[ DeepAI.org ]


---

# Assumptions &#129300;

> ## .gray[ The size of a population changes over time ]

> ## .gray[ Some changes are density dependent ]

> ## .blue[ Some changes owe to an unpredictable environment ]


---

<br>

## .blue.center[ &#129299; Discrete-time Gompertz model ]

$$\LARGE N_t = N_{t-1} \exp{(r_{\max} + (b - 1) \log(N_{t-1}))} \underbrace{\exp{(w_t)}}_{environment}$$

<br>

## .blue.center[ &#128587; in other words ]

## .center[A population bumps up & down toward its long-term mean ]


---

# Example of stochastic Gompertz dynamics

```{r ex_gompertz_stoch, fig.align = "center", fig.dim=c(6,3)}
set.seed(20220401)

ww <- rnorm(TT, 0, sqrt(0.1))

for(tt in 2:TT) {
  NN[tt] <- NN[tt-1] * exp(r_max + (b - 1) * log(NN[tt-1]) + ww[tt])
}

par(mai = c(1, 0.5, 0, 0), omi = c(0, 0, 0, 0))
plot.ts(NN, lwd = 2, type = "o", pch = 16, col = "dodgerblue",
        yaxt = "n",
        ylab = "")
# text(x = 5, y = 130, expression(italic(r[max])==1))
# text(x = 5, y = 110, expression(italic(b)==0.8))
# text(x = 5, y = 90, expression(italic(q)==0.1))
mtext(expression(italic(N[t])),
      side = 2, line = 1, cex = 1.5, las = 1)
```


---

class: center, middle, inverse

# Quantifying population stability


---

class: frimg
background-image: url(figs/May_1972_stability.png)
background-position: 50% 75%
background-size: 60%

# Population equilibria

### .blue.center[ In deterministic models, equilibria are a point or stable limit cycle ]

### .gray.citation[May (1972) _Science_]


---

# Population equilibria

### .blue.center[ In stochastic models, the "equilibrium" is a _stationary distribution_ ]

```{r stat_dist, fig.align = "center", fig.dim=c(4, 4), dpi=300, out.height = "45%", out.width = "45%"}
par(mai = c(1, 0.5, 0.1, 0.5), omi = rep(0, 4))

s1 <- seq(-5, 5, 0.25) 
s2 <- seq(-5, 5, 0.25)
mu1    <- c(0, 0)
sigma1 <- matrix(c(6, 3, 3, 8), nrow = 2)
ff <- function(x, y) mnormt::dmnorm(cbind(x, y), mu1, sigma1)
zz <- outer(s1, s2, ff)
aa <- seq(1, 26, 5) /100
contour(s1, s2, zz,
        nlevels = 4, lwd = 3, labcex = 1.2,
        xaxt = "n", yaxt = "n")
box(lwd = 3)
mtext("Population x",
      side = 1, line = 0.5, cex = 1.5)
mtext("Population y",
      side = 2, line = 0.5, cex = 1.5)
```


---

# Recall our Gompertz model in log-space

$$\LARGE x_t = r_{max} + b x_{t-1} + w_t$$


---

# Recall our Gompertz model in log-space

$$\LARGE x_t = r_{max} + b x_{t-1} + w_t$$

## .center[if we assume that]

$$\LARGE 0 < b < 1; ~~ w_t \sim \text{N}(0, q)$$

## .blue.center[then this process is _stationary_]


---

# Recall our Gompertz model in log-space

$$\LARGE x_t = r_{max} + b x_{t-1} + w_t$$

## .center[if we assume that]

$$\LARGE 0 < b < 1; ~~ w_t \sim \text{N}(0, q)$$

## .blue.center[and from this we can show that]

$$\LARGE \text{Var}(x_t) = \frac{\text{Var}(w_t)}{1 - b^2}$$


---

# Stability is inversely related to the variance

$$\LARGE \text{Var}(x_t) = \frac{\text{Var}(w_t)}{1 - b^2} ~~ \Rightarrow ~~ \frac{1}{\text{Var}(x_t)} = \frac{1 - b^2}{\text{Var}(w_t)}$$

## .left[which implies a .blue[population] is .blue[more stable] when]

## .center[ the strength of .orange[density-dependence increases]]

## .right[and the .green[environment] is .green[less variable]]


---

# Populations within the same environment

```{r uni_stationary, fig.align='center', fig.dim=c(8,4)}

TT <- 50
NN <- 10

x1 <- w1 <- matrix(rnorm(TT*NN, 0, 1), nrow = NN)
x2 <- w2 <- matrix(rnorm(TT*NN, 0, 1), nrow = NN)

x1[,1] <- -7
x2[,1] <- -7

b1 <- 0.5
b2 <- 0.9

for(i in 1:NN) {
  for(tt in 2:TT) {
    x1[i,tt] <- b1 * x1[i,tt-1] + w1[i,tt]
    x2[i,tt] <- b2 * x2[i,tt-1] + w2[i,tt]
  }
}

## determine the plot range and all the things needed for the barplots and lines
xx <- seq(-8, 6, length.out = 100) # evaluation points for the overlaid density
h1 <- dnorm(xx, 0, 1) # density points
s1 <- dnorm(xx, 0, sqrt(1/(1 - 0.5^2)))
s2 <- dnorm(xx, 0, sqrt(1/(1 - 0.9^2)))

clr1 <- c("#f7fbff",
          "#deebf7",
          "#c6dbef",
          "#9ecae1",
          "#6baed6",
          "#4292c6",
          "#2171b5",
          "#08519c",
          "#08306b")

clr2 <- c("#fff5f0",
          "#fee0d2",
          "#fcbba1",
          "#fc9272",
          "#fb6a4a",
          "#ef3b2c",
          "#cb181d",
          "#a50f15",
          "#67000d")

layout(matrix(c(1, 2, 3, 4), 1, 4), widths = c(4, 1, 4, 1))

## ts plots
par(mai = c(1, 1, 0.5, 0), omi = c(0, 0, 0, 0))
plot(seq(TT), x1[1,], las = 1, col = "dodgerblue", type = "l", lwd = 2, ylim = range(x2),
     xlab = "Time", ylab = expression(italic(x[t])~(log~density)), main = "",
     cex.axis = 1.5, cex.lab = 2)
mtext(expression(italic(b)==0.5),
      side = 3, line = 1, cex = 1.3, adj = 0, col = "dodgerblue")
mtext(expression( Var( italic(x[t]) ) == 1.1),
      side = 3, line = 0.7, cex = 1.3, adj = 1, col = "dodgerblue")
for(i in 2:NN) {
  lines(x1[i,],
        col = clr1[i-1], lwd = 2)
}

## marginal densities
par(mai = c(1, 0, 0.5, 0))
plot(h1, xx, type = "l", ylim = range(x2),
     xaxt = "n", yaxt = "n", bty = "n",
     xlab = "", ylab = "", col = "darkgray", lwd = 2)
lines(s1, xx, col = "dodgerblue", lwd = 2)

## ts plots
par(mai = c(1, 1, 0.5, 0))
plot(seq(TT), x2[1,], las = 1, col = "indianred", type = "l", lwd = 2, ylim = range(x2),
     xlab = "Time", ylab = expression(italic(x[t])~(log~density)), main = "",
     cex.axis = 1.5, cex.lab = 2)
mtext(expression(italic(b)==0.9),
      side = 3, line = 1, cex = 1.3, adj = 0, col = "indianred")
mtext(expression(Var(italic(x[t]))==2.3),
      side = 3, line = 0.7, cex = 1.3, adj = 1, col = "indianred")
for(i in 2:NN) {
  lines(x2[i,],
        col = clr2[i-1], lwd = 2)
}

## marginal densities
par(mai = c(1, 0, 0.5, 0))
plot(h1, xx, type = "l", ylim = range(x2),
     xaxt = "n", yaxt = "n", bty = "n",
     xlab = "", ylab = "", col = "darkgray", lwd = 2)
lines(s2, xx, col = "indianred", lwd = 2)
```


---

# Populations within the same environment

```{r uni_stationary_2, fig.align='center', fig.dim=c(8,4)}
layout(matrix(c(1, 2, 3, 4), 1, 4), widths = c(4, 1, 4, 1))

## ts plots
par(mai = c(1, 1, 0.5, 0), omi = c(0, 0, 0, 0))
plot(seq(TT), x1[1,], las = 1, col = "dodgerblue", type = "l", lwd = 2, ylim = range(x2),
     xlab = "Time", ylab = expression(italic(x[t])~(log~density)), main = "",
     cex.axis = 1.5, cex.lab = 2)
mtext("More stable",
      side = 3, line = 1, cex = 1.5, col = "dodgerblue")
for(i in 2:NN) {
  lines(x1[i,],
        col = clr1[i-1], lwd = 2)
}

## marginal densities
par(mai = c(1, 0, 0.5, 0))
plot(h1, xx, type = "l", ylim = range(x2),
     xaxt = "n", yaxt = "n", bty = "n",
     xlab = "", ylab = "", col = "darkgray", lwd = 2)
lines(s1, xx, col = "dodgerblue", lwd = 2)

## ts plots
par(mai = c(1, 1, 0.5, 0))
plot(seq(TT), x2[1,], las = 1, col = "indianred", type = "l", lwd = 2, ylim = range(x2),
     xlab = "Time", ylab = expression(italic(x[t])~(log~density)), main = "",
     cex.axis = 1.5, cex.lab = 2)
mtext("Less stable",
      side = 3, line = 1, cex = 1.5, col = "indianred")
for(i in 2:NN) {
  lines(x2[i,],
        col = clr2[i-1], lwd = 2)
}

## marginal densities
par(mai = c(1, 0, 0.5, 0))
plot(h1, xx, type = "l", ylim = range(x2),
     xaxt = "n", yaxt = "n", bty = "n",
     xlab = "", ylab = "", col = "darkgray", lwd = 2)
lines(s2, xx, col = "indianred", lwd = 2)
```


---

class: inverse, center, middle

# Changes in a community over time


---

# Drivers of community dynamics

## .center[.blue[Number today] is a function of the .blue2[number yesterday]...<sup>&nbsp;</sup> ]

```{r MAR_diag_1, dpi=300, fig.height=4, fig.width = 8, out.height = "90%", out.width = "90%", fig.align='center', echo=FALSE, warning = FALSE}
par(mai = c(1, 0, 0, 0), omi=rep(0,4))
## boundaries
ss <- 5
nn <- 8
rr <- ss*3
cc <- ss*nn
## mid-points
xm <- seq(5,cc-ss,rr)
ymt <- rr - ss/2
ymb <- ss/2
## arrow locs
y0 <- rr - ss
y1 <- ss
## empty plot space
plot(c(0,cc), c(0,rr), type = "n", xlab = "", ylab = "",
     xaxt = "n", yaxt = "n", bty = "n")
## top row
symbols(x = xm[2], y = ymt, rectangles = matrix(c(2*ss,ss),1,2),
        lty = "solid",  bg = "#030c84", fg = NA,
        inches = FALSE, add = TRUE, lwd = 3)
text("Number", x = xm[2], y = ymt, cex = 1.8, col = "#ffffff", pos = 3)
text("yesterday", x = xm[2], y = ymt, cex = 1.8, col = "#ffffff", pos = 1)
## arrows
arrows(x0 = xm[2], y0 = y0, y1 = y1,
       col = "#030c84", lwd = 3, length = 0.12)
## bottom row: obs
symbols(x = xm[2], y = ymb, rectangles = matrix(c(2*ss,ss),1,2),
        lty = "solid",  bg = "#488fdf", fg = NA,
        inches = FALSE, add = TRUE, lwd = 3)
text("Number", x = xm[2], y = ymb, cex = 1.8, col = "#ffffff", pos = 3)
text("today", x = xm[2], y = ymb, cex = 1.8, col = "#ffffff", pos = 1)
```


---

# Drivers of community dynamics

## .center[and the number of .red[predators], .orange[prey] & .purple[competitors]...<sup>&nbsp;</sup>]

```{r MAR_diag_2, dpi=300, fig.height=4, fig.width = 8, out.height = "90%", out.width = "90%", fig.align='center', echo=FALSE, warning = FALSE}
par(mai = c(1, 0, 0, 0), omi=rep(0,4))
## empty plot space
plot(c(0,cc), c(0,rr), type = "n", xlab = "", ylab = "",
     xaxt = "n", yaxt = "n", bty = "n")
## top row
symbols(x = xm, y = rep(ymt,3),
        rectangles = matrix(c(2*ss,ss),3,2,byrow = TRUE),
        lty = "solid",  bg = c("#c10101","#ff8100","#844870"),
        fg = NA,
        inches = FALSE, add = TRUE, lwd = 3)
text(c("Predators","Prey","Competitors"),
     x = xm, y = rep(ymt,3), cex = 1.7, col = "#ffffff", pos = 3)
text("yesterday", x = xm, y = rep(ymt,3), cex = 1.7, col = "#ffffff", pos = 1)
## arrows
arrows(x0 = ss*seq(2,6,2), x1 = ss*seq(3,5),
       y0 = y0, y1 = y1,
       col=c("#c10101","#ff8100","#844870"), lwd = 3, length = 0.12)
## bottom row: obs
symbols(x = xm[2], y = ymb, rectangles = matrix(c(2*ss,ss),1,2),
        lty = "solid",  bg = "#488fdf", fg = NA,
        inches = FALSE, add = TRUE, lwd = 3)
text("Number", x = xm[2], y = ymb, cex = 1.8, col = "#ffffff", pos = 3)
text("today", x = xm[2], y = ymb, cex = 1.8, col = "#ffffff", pos = 1)
```


---

# Drivers of community dynamics

## .center[ and .gray[parasites]<sup>*</sup>, .gray[diseases, etc]... ]

```{r MAR_diag_3, dpi=300, fig.height=4, fig.width = 8, out.height = "90%", out.width = "90%", fig.align='center', echo=FALSE, warning = FALSE}
par(mai = c(1, 0, 0, 0), omi=rep(0,4))
## empty plot space
plot(c(0,cc), c(0,rr), type = "n", xlab = "", ylab = "",
     xaxt = "n", yaxt = "n", bty = "n")
## top row
symbols(x = xm[2], y = ymt, rectangles = matrix(c(2*ss,ss),1,2),
        lty = "solid",  bg = "#656565", fg = NA,
        inches = FALSE, add = TRUE, lwd = 3)
# text("Don't want", x = xm[2], y = ymt, cex = 1.8, col = "#ffffff", pos = 3)
# text("to imagine", x = xm[2], y = ymt, cex = 1.8, col = "#ffffff", pos = 1)
text("Try not to", x = xm[2], y = ymt, cex = 1.8, col = "#ffffff", pos = 3)
text("imagine", x = xm[2], y = ymt, cex = 1.8, col = "#ffffff", pos = 1)
## arrows
arrows(x0 = xm[2], y0 = y0, y1 = y1,
       col = "#656565", lwd = 3, length = 0.12)
## bottom row: obs
symbols(x = xm[2], y = ymb, rectangles = matrix(c(2*ss,ss),1,2),
        lty = "solid",  bg = "#488fdf", fg = NA,
        inches = FALSE, add = TRUE, lwd = 3)
text("Number", x = xm[2], y = ymb, cex = 1.8, col = "#ffffff", pos = 3)
text("today", x = xm[2], y = ymb, cex = 1.8, col = "#ffffff", pos = 1)
```

### .citation[ <sup>*</sup>C Wood, pers comm ]


---

# Drivers of community dynamics

## .center[and _known_ .green[external forces]...<sup>&nbsp;</sup>]

```{r MAR_diag_4, dpi=300, fig.height=4, fig.width = 8, out.height = "90%", out.width = "90%", fig.align='center', echo=FALSE, warning = FALSE}
par(mai = c(1, 0, 0, 0), omi=rep(0,4))
## empty plot space
plot(c(0,cc), c(0,rr), type = "n", xlab = "", ylab = "",
     xaxt = "n", yaxt = "n", bty = "n")
## top row
symbols(x = xm[2], y = ymt, rectangles = matrix(c(2*ss,ss),1,2),
        lty = "solid",  bg = "#339933", fg = NA,
        inches = FALSE, add = TRUE, lwd = 3)
text("External", x = xm[2], y = ymt, cex = 1.8, col = "#ffffff", pos = 3)
text("forces", x = xm[2], y = ymt, cex = 1.8, col = "#ffffff", pos = 1)
## arrows
arrows(x0 = xm[2], y0 = y0, y1 = y1,
       col = "#339933", lwd = 3, length = 0.12)
## bottom row: obs
symbols(x = xm[2], y = ymb, rectangles = matrix(c(2*ss,ss),1,2),
        lty = "solid",  bg = "#488fdf", fg = NA,
        inches = FALSE, add = TRUE, lwd = 3)
text("Number", x = xm[2], y = ymb, cex = 1.8, col = "#ffffff", pos = 3)
text("today", x = xm[2], y = ymb, cex = 1.8, col = "#ffffff", pos = 1)
```


---

# Drivers of community dynamics

## .center[and _unknown_ .red[random forces]<sup>&nbsp;</sup>]

```{r MAR_diag_5, dpi=300, fig.height=4, fig.width = 8, out.height = "90%", out.width = "90%", fig.align='center', echo=FALSE, warning = FALSE}
par(mai = c(1, 0, 0, 0), omi=rep(0,4))
## empty plot space
plot(c(0,cc), c(0,rr), type = "n", xlab = "", ylab = "",
     xaxt = "n", yaxt = "n", bty = "n")
## top row
symbols(x = xm[2], y = ymt, rectangles = matrix(c(2*ss,ss),1,2),
        lty = "solid",  bg = "#c10101", fg = NA,
        inches = FALSE, add = TRUE, lwd = 3)
text("Random", x = xm[2], y = ymt, cex = 1.8, col = "#ffffff", pos = 3)
text("forces", x = xm[2], y = ymt, cex = 1.8, col = "#ffffff", pos = 1)
## arrows
arrows(x0 = xm[2], y0 = y0, y1 = y1,
       col = "#c10101", lwd = 3, length = 0.12)
## bottom row: obs
symbols(x = xm[2], y = ymb, rectangles = matrix(c(2*ss,ss),1,2),
        lty = "solid",  bg = "#488fdf", fg = NA,
        inches = FALSE, add = TRUE, lwd = 3)
text("Number", x = xm[2], y = ymb, cex = 1.8, col = "#ffffff", pos = 3)
text("today", x = xm[2], y = ymb, cex = 1.8, col = "#ffffff", pos = 1)
```


---

# Model for community dynamics

<br>

$$\LARGE x_{i,t} = r_{max, i} + \underbrace{\sum^{N}_{j = 1}{b_{i,j}} x_{j,t}}_{\substack{\text{species} \\ \text{interactions}}} + \underbrace{\sum^{P}_{k = 1}{c_{i,k}} z_{k,t-h}}_{\substack{\text{external} \\ \text{drivers}}} + \underbrace{w_t}_{\substack{\text{random} \\ \text{stuff}}}$$

### .citation.gray[ (in log space) ] 


---

class: inverse, middle, center

# What percentage of the total variance in a community comes from species interactions?


---

# A 2009 meta-analysis found

> ## .orange[moths in the United Kingdom (11-54%)]

### .gray.citation[Mutshinda et al (2009) _Proc R Soc B_]


---

# A 2009 meta-analysis found

> ## .orange[moths in the United Kingdom (11-54%)]

> ## .blue2[nearshore fishes & inverts in the UK (2-15%)]

### .gray.citation[Mutshinda et al (2009) _Proc R Soc B_]


---

# A 2009 meta-analysis found

> ## .orange[moths in the United Kingdom (11-54%)]

> ## .blue2[nearshore fishes & inverts in the UK (2-15%)]

> ## .green[birds in Hubbard Brook, New Hampshire (1-17%)]

### .gray.citation[Mutshinda et al (2009) _Proc R Soc B_]


---

# A 2009 meta-analysis found

> ## .orange[moths in the United Kingdom (11-54%)]

> ## .blue2[nearshore fishes & inverts in the UK (2-15%)]

> ## .green[birds in Hubbard Brook, New Hampshire (1-17%)]

> ## .purple[rodents in Sevilleta, New Mexico (11-37%)]

### .gray.citation[Mutshinda et al (2009) _Proc R Soc B_]


---

class: inverse, middle, center

# How do these estimates compare <br> to freshwater communities?


---

# Contribution of species interactions

## .blue.center[ Recall the variance for a single population ]

$$\LARGE \text{Var}(popn) = \frac{\text{Var}(env)}{1 - b^2}$$ 

## .blue.center[ (via algebra) the proportion owing to density dependence is]

$$\LARGE \frac{\text{Var}(popn) - \text{Var}(env)}{\text{Var}(popn)} = b^2$$


---

# Model for community dynamics

<br>

$$\LARGE x_{i,t} = r_{max, i} + \underbrace{\sum^{N}_{j = 1}{b_{i,j}} x_{j,t}}_{\substack{\text{species} \\ \text{interactions}}} + \underbrace{\sum^{P}_{k = 1}{c_{i,k}} z_{k,t-h}}_{\substack{\text{external} \\ \text{drivers}}} + \underbrace{w_t}_{\substack{\text{random} \\ \text{stuff}}}$$

### .citation.gray[ (in log space) ] 


---

# Model for community dynamics

$$\large \begin{bmatrix}
x_1 \\
\vdots \\
x_N
\end{bmatrix}_t =
\begin{bmatrix}
r_1 \\
\vdots \\
r_N
\end{bmatrix} +
\begin{bmatrix}
b_{1,1} & \dots & b_{1,N} \\
\vdots & \ddots & \vdots \\
b_{N,1} & \dots & b_{N,N}
\end{bmatrix} \begin{bmatrix}
x_1 \\
\vdots \\
x_N
\end{bmatrix}_{t-1}
+
\begin{bmatrix}
c_{1,1} & \dots & c_{1,P} \\
\vdots & \ddots & \vdots \\
c_{N,1} & \dots & c_{N,P}
\end{bmatrix} 
\begin{bmatrix}
z_1 \\
\vdots \\
z_P
\end{bmatrix}_{t-h} +
\begin{bmatrix}
w_1 \\
\vdots \\
w_N
\end{bmatrix}_t$$

## .center[and more compactly as]

$$\LARGE \mathbf{x}_t = \mathbf{r} +  \mathbf{B} \mathbf{x}_{t-1} + \mathbf{C} \mathbf{z}_{t-h} + \mathbf{w}_t$$

### .citation.gray[ (in log space with matrix notation) ] 


---

# Stationary variance of a community

## .blue.center[ Given our multivariate model of community dynamics ]

$$\LARGE \mathbf{x}_t = \mathbf{r} +  \mathbf{B} \mathbf{x}_{t-1} + \mathbf{C} \mathbf{z}_{t-h} + \mathbf{w}_t  \\
~ \\
\LARGE \mathbf{w}_t \sim \text{MVN}(\mathbf{0}, \mathbf{Q})$$

## .blue.center[ the stationary variance is ]

$$\LARGE \text{Var}(\mathbf{x}_t) = \mathbf{B} \text{Var}(\mathbf{x}_t) \mathbf{B}^\top + \mathbf{C} \text{Var}(\mathbf{z}_{t-h}) \mathbf{C}^\top + \mathbf{Q}$$


---

# Aside: matrix determinants

### .blue.center[ Consider a cube whose sides are 2 units; it's volume is 8 cubic units]

```{r plot_cube, fig.align='center', dpi=300, fig.height=4, fig.width = 8, out.height = "90%", out.width = "90%"}

par(mai = c(1, 0, 0, 0), omi = rep(0, 4))

plot(c(0, 3), c(0, 3), type = "n",
     asp = 1, xlim = c(0, 3), ylim = c(0, 3),
     xaxt = "n", yaxt = "n", bty = "n",
     xlab = "", ylab = "")

segments(0, 2, 1, 2 + 1, lwd = 3, col = "darkgray")
segments(0, 2, 2, 2, lwd = 3, col = "darkgray")
segments(2, 0, 2, 2, lwd = 3, col = "darkgray")
segments(1, 1, 1, 2 + 1, lwd = 3, col = "darkgray")
segments(1, 2 + 1, 2 + 1, 2 + 1, lwd = 3, col = "darkgray")
segments(2, 2, 2 + 1, 2 + 1, lwd = 3, col = "darkgray")
segments(2, 0, 2 + 1, 1, lwd = 3, col = "darkgray")
segments(2 + 1, 1, 2 + 1, 2 + 1, lwd = 3, col = "darkgray")
segments(1, 1, 2 + 1, 1, lwd = 3, col = "darkgray")

segments(0, 0, 2, 0, lwd = 3, col = "black")
segments(0, 0, 1, 1, lwd = 3, col = "black")
segments(0, 0, 0, 2, lwd = 3, col = "black")

text(1, 0, "2", xpd = NA, cex = 1.5, pos = 1)
text(0.5, 0.6, "2", xpd = NA, cex = 1.5, pos = 3)
text(0, 1, "2", xpd = NA, cex = 1.5, pos = 2)
```


---

# Aside: matrix determinants

### .blue.center[ We can define this cube with 3 vectors for the cube's vertices ]

```{r plot_cube_2, fig.align='center', dpi=300, fig.height=4, fig.width = 8, out.height = "90%", out.width = "90%"}

par(mai = c(1, 0, 0, 0), omi = rep(0, 4))

plot(c(0, 3), c(0, 3), asp = 1, xlim = c(0, 3), ylim = c(0, 3), type = "n",
     xaxt = "n", yaxt = "n", xlab = "", ylab = "", bty = "n")

segments(0, 2, 1, 2 + 1, lwd = 3, col = "darkgray")
segments(0, 2, 2, 2, lwd = 3, col = "darkgray")
segments(2, 0, 2, 2, lwd = 3, col = "darkgray")
segments(1, 1, 1, 2 + 1, lwd = 3, col = "darkgray")
segments(1, 2 + 1, 2 + 1, 2 + 1, lwd = 3, col = "darkgray")
segments(2, 2, 2 + 1, 2 + 1, lwd = 3, col = "darkgray")
segments(2, 0, 2 + 1, 1, lwd = 3, col = "darkgray")
segments(2 + 1, 1, 2 + 1, 2 + 1, lwd = 3, col = "darkgray")
segments(1, 1, 2 + 1, 1, lwd = 3, col = "darkgray")

arrows(0, 0, 2, 0, length = 0.1, lwd = 3, col = "blue")
arrows(0, 0, 1, 1, length = 0.1, lwd = 3, col = "red")
arrows(0, 0, 0, 2, length = 0.1, lwd = 3, col = "purple")

text(2, 0, "[2, 0, 0]", xpd = NA, cex = 1.5, pos = 1, col = "blue")
text(1, 1, "[0, 2, 0]", xpd = NA, cex = 1.5, pos = 3, col = "red")
text(0, 2, "[0, 0, 2]", xpd = NA, cex = 1.5, pos = 2, col = "purple")
```


---

# Aside: matrix determinants

### .blue.center[ If we combine the 3 vectors into a matrix, the determinant gives the volume ]

$$\LARGE \text{det}
\begin{bmatrix}
2 & 0 & 0 \\
0 & 2 & 0 \\
0 & 0 & 2
\end{bmatrix} 
= 8$$


---

# Effect of species interactions

## .blue.center[ Proportion attributable to species interactions is
]

$$\LARGE 
\frac{\text{det}[\text{Var}(comm) - \text{Var}(env)]}{\text{det}(\text{Var}(comm))} = \text{det}(\mathbf{B})^2$$


---

# Freshwater plankton communities

> ## .blue[Peter/Paul/Tues Lakes in Michigan (Ives et al 2003)]

> ## .blue[L Washington in Washington (Hampton et al 2006)]

> ## .blue[L Müggelsee in Germany (Gsell et al 2016)]

> ## .blue[L Aleknagik in Alaska (Carter et al 2017)]


---

class: middle, center

# Species interactions in these lakes accounted for .red[no more than 3%] of the total variation


---

class: inverse, center, middle

# Bookmark here


---

# quick calcs

```{r, eval = FALSE}
## Gsell et al (2016) https://doi.org/10.1016/j.ecolind.2015.11.014
## L Müggelsee in Germany
detB <- c(0.14, 0.13, 0.12)
detB^2 # ~= 0.0196 0.0169 0.0144

## Carter et al (2017) https://doi.org/10.1186/s40665-017-0031-x
## L Aleknagik in Alaska

BB <- matrix(c(0.84, -0.2, 0, 0, 0,
               0, 0.52, 0, 0, 0,
               0.51, 0, 0.3, 0, 0.18,
               0.18, 0, 0, 0.01, 0,
               0.41, 0.36, -0.41, -0.27, 0.43),
             5, 5, byrow = TRUE)

det(BB)^2 # ~= 0.0

## Hampton et al (2006)
## L Washington in WA
BB <- matrix(c(0.52, 0, -0.06, 0, 0, 0, 0,
               0, 0.44, 0, 0, 0, 0, 0,
               0, 0, 0.92, 0, 0, 0, 0,
               0, 0, 0, 0.66, -0.16, 0, -0.12,
               0.23, 0, -0.11, 0, 0.57, 0, 0,
               0.09, 0, 0, 0, -0.22, 0.64, -0.14,
               0.23, 0, 0, 0, -0.27, 0, 0.54),
             7, 7, byrow = TRUE)

det(BB)^2 # ~= 0.001

## Ives et al 2003 
## Tuesday Lake

BB <- matrix(c(0.5, 0, 0, 0,
               0, 0.61, -0.019, 0,
               0, 0, 0.76, 0,
               0, 0.1, 0, 0.56),
             4, 4, byrow = TRUE)

det(BB)^2 # ~= 0.02

## Peter
BB <- matrix(c(0.5, 0, 0, 0,
               -0.77, 0.61, -0.019, 0,
               0, 0.33, 0.95, 0,
               0, 0.1, 0, 0.56),
             4, 4, byrow = TRUE)

det(BB)^2 # ~= 0.03

## Paul
BB <- matrix(c(0.5, -0.36, 0, 0,
               0, 0.072, -0.019, -0.1,
               0, 0, 0.76, 0,
               0, 0.1, 0, 0.56),
             4, 4, byrow = TRUE)

det(BB)^2 # ~= 0.0

```



---

# Where are the important interactions?

.blue[
### Reactivity tells us something about the community as a whole

### But what about the importance of _particular interactions_?
]


---

# Where are the important interactions?

.blue[
### Are intra- or inter-specific interactions more important to stability?

### Are top-down or bottom-up interactions more important to stability?
]


---

# Sensitivity of $\pi_{\mathbf{B}}$ to interactions

.blue[
### We can examine the change in $\pi_{\mathbf{B}}$ with respect to the $(i,j)$ element of $\mathbf{B}$ using
]

$$\begin{align}
\frac{\partial \pi_\mathbf{B}}{\partial \mathbf{B}_{ij}} &=  \frac{\partial \text{det}(\mathbf{B})^2}{\partial \mathbf{B}_{ij}} \\
& \\
 &= \left[ 2 ~ \text{det}(\mathbf{B}) (\mathbf{B}^{-1})^\top \right]_{ij}
\end{align}$$


---

class: center, middle, inverse

# How does one actually do this?


---

# .blue[Canned **R** packages]

## `{dlm}`, `{vars}`, `{MARSS}`<sup>*</sup>

<br>

# .green[Code-your-own languages]

## `JAGS`, `Stan`, `TMB`

.footnoteSm.gray[
<sup>\*</sup>Holmes, Ward, Scheuerell (2020) _Analysis of multivariate time-series using the MARSS package_
]


---

class: center, middle, inverse

# The Lake Washington Story


---

# Acknowledgments

.green[
## [the late] W. T. Edmondson (UW)

## Daniel Schindler (UW)

## Arni Litt, Sally Abella, and **many** others (UW)
]


---

class: frimg

background-image: url(figs/LWA_press.png)
background-size: 70%
background-position: 50% 60%

# The Lake Washington Story


---

class: frimg

background-image: url(figs/LWA_CW.png)
background-size: 80%
background-position: 50% 50%

# The Lake Washington Story

.gray.citation[Hampton, Scheuerell & Schindler (2006) _L&O_]


---

# Analysis: plankton groups

.blue[
### I considered two 6-year time periods:
]
.green[
### 1977-1982

### 1989-1994
]


---

# Analysis: plankton groups

.blue[
## Small phytoplankton 

## Large phytoplankton

## _Daphnia_

## non-_Daphnia_
]


---

class: frimg

background-image: url(figs/plank.png)
background-size: 80%
background-position: 50% 55%

# The plankton


---

class: frimg

background-image: url(figs/covars.png)
background-size: 85%
background-position: 50% 50%

# The covariates


---

# Stability metrics

| Metric | | Early | | Late |  | Ives |
|:----|:-----:|:-----:|:-----:|:-----:|:-----:|:-----:|
| Return rate (mean) |    | 0.89 |   | 0.65 |   | 0.77 |
| Return rate (var) |   | 0.79 |   | 0.42 |   | 0.59 |
| Reactivity |   | 1.0 |   | 0.41 |   | -0.26 |
| % from species |   | 4% |   | 1% |   | 1% |

.blue[
### The late period in L WA is more stable than the early

### Midwestern lake is intermediate to the 2 L WA periods
]


---

# Stability metrics

| Metric | | Early | | Late |  | Ives |
|:----|:-----:|:-----:|:-----:|:-----:|:-----:|:-----:|
| Return rate (mean) |    | 0.89 |   | 0.65 |   | 0.77 |
| Return rate (var) |   | 0.79 |   | 0.42 |   | 0.59 |
| Reactivity |   | 1.0 |   | 0.41 |   | -0.26 |
| % from species |   | 4% |   | 1% |   | 1% |

.blue[
### A previous meta-analysis of many different ecosystems found species interactions accounted for 5-60% (but only 2-10% in fish)
]

.gray.citation[Mutshinda et al (2009) _Proc R Soc B_]


---

# Sensitivity of $\pi_\mathbf{B}$

.blue[
### Early period: bottom-up effects of phytoplankton
]

.green[
### Late period: rather mixed and modest
]

.orange[
### Midwest: density-dependent effects
]


---

# Summary

.blue[
### Food web studies often focus on pairwise interactions

### Examining the stability of the community is important as well
]

.futnote.purple[`r icon_style(fontawesome("envelope"), fill = "#844870")` scheuerl@uw.edu]

.citation.blue[`r icon_style(fontawesome("twitter"), fill = "#488fdf")` @mark_scheuerell]


---

# This presentation

### https://github.com/mdscheuerell/WSN-2024


---

background-image: url(figs/shilshole.png)
background-size: cover


